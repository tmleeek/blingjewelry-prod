/*
   Copyright (c) 2014 Magento Inc. (http://www.magentocommerce.com)
 @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
*/
if("undefined"==typeof Product)var Product={};Product.Bundle=Class.create();
Product.Bundle.prototype={initialize:function(a){this.config=a;if(a.defaultValues)for(var c in a.defaultValues)if(this.config.options[c].isMulti){for(var b=[],e=0;e<a.defaultValues[c].length;e++)b.push(a.defaultValues[c][e]);this.config.selected[c]=b}else this.config.selected[c]=Array(a.defaultValues[c]+"");this.reloadPrice()},changeSelection:function(a){var c=a.id.split("-");if(this.config.options[c[2]].isMulti){selected=[];if("SELECT"==a.tagName)for(var b=0;b<a.options.length;b++)a.options[b].selected&&
""!=a.options[b].value&&selected.push(a.options[b].value);else if("INPUT"==a.tagName)for(selector=c[0]+"-"+c[1]+"-"+c[2],selections=$$("."+selector),b=0;b<selections.length;b++)selections[b].checked&&""!=selections[b].value&&selected.push(selections[b].value);this.config.selected[c[2]]=selected}else{this.config.selected[c[2]]=""!=a.value?Array(a.value):[];this.populateQty(c[2],a.value);var b=$("bundle-option-"+c[2]+"-tier-prices"),e="";""!=a.value&&1==this.config.options[c[2]].selections[a.value].customQty&&
(e=this.config.options[c[2]].selections[a.value].tierPriceHtml);b.update(e)}this.reloadPrice()},reloadPrice:function(){var a=0,c=0,b=0,e;for(e in this.config.selected)if(this.config.options[e])for(var f=0;f<this.config.selected[e].length;f++)var d=this.selectionPrice(e,this.config.selected[e][f]),a=a+Number(d[0]),c=c+Number(d[1]),b=b+Number(d[2]);taxCalcMethod==CACL_TOTAL_BASE&&(a=a.toFixed(10),a=b.toFixed(10)-a,a=b-Math.round(100*a)/100);"0"==this.config.priceType&&(a=Math.round(100*a)/100,c=Math.round(100*
c)/100,b=Math.round(100*b)/100);$(document).fire("bundle:reload-price",{price:a,priceInclTax:b,dispositionPrice:c,bundle:this}).noReloadPrice||(optionsPrice.specialTaxPrice="true",optionsPrice.changePrice("bundle",a),optionsPrice.changePrice("nontaxable",c),optionsPrice.changePrice("priceInclTax",b),optionsPrice.reload());return a},selectionPrice:function(a,c){if(""==c||"none"==c)return 0;var b=null,e,f,b=1!=this.config.options[a].selections[c].customQty||this.config.options[a].isMulti?this.config.options[a].selections[c].qty:
$("bundle-option-"+a+"-qty-input")?$("bundle-option-"+a+"-qty-input").value:1;if("0"==this.config.priceType){price=this.config.options[a].selections[c].price;tierPrice=this.config.options[a].selections[c].tierPrice;for(var d=0;d<tierPrice.length;d++)Number(tierPrice[d].price_qty)<=b&&Number(tierPrice[d].price)<=price&&(price=tierPrice[d].price,e=tierPrice[d].priceInclTax,f=tierPrice[d].priceExclTax)}else selection=this.config.options[a].selections[c],price="0"==selection.priceType?selection.priceValue:
this.config.basePrice*selection.priceValue/100;d=this.config.options[a].selections[c].plusDisposition+this.config.options[a].selections[c].minusDisposition;this.config.specialPrice&&(newPrice=price*this.config.specialPrice/100,price=Math.min(newPrice,price));selection=this.config.options[a].selections[c];void 0!==e&&void 0!==f?(priceInclTax=e,price=f):void 0!==selection.priceInclTax?(priceInclTax=selection.priceInclTax,price=void 0!==selection.priceExclTax?selection.priceExclTax:selection.price):
priceInclTax=price;"1"==this.config.priceType||taxCalcMethod==CACL_TOTAL_BASE?b=[price*b,d*b,priceInclTax*b]:taxCalcMethod==CACL_UNIT_BASE?(price=(Math.round(100*price)/100).toString(),d=(Math.round(100*d)/100).toString(),priceInclTax=(Math.round(100*priceInclTax)/100).toString(),b=[price*b,d*b,priceInclTax*b]):(price=(Math.round(price*b*100)/100).toString(),d=(Math.round(d*b*100)/100).toString(),priceInclTax=(Math.round(priceInclTax*b*100)/100).toString(),b=[price,d,priceInclTax]);return b},populateQty:function(a,
c){""==c||"none"==c?this.showQtyInput(a,"0",!1):1==this.config.options[a].selections[c].customQty?this.showQtyInput(a,this.config.options[a].selections[c].qty,!0):this.showQtyInput(a,this.config.options[a].selections[c].qty,!1)},showQtyInput:function(a,c,b){elem=$("bundle-option-"+a+"-qty-input");elem.value=c;elem.disabled=!b;b?elem.removeClassName("qty-disabled"):elem.addClassName("qty-disabled")},changeOptionQty:function(a,c){var b=!0;"undefined"==typeof c||8!=c.keyCode&&46!=c.keyCode||(b=!1);b&&
(0==Number(a.value)||isNaN(Number(a.value)))&&(a.value=1);parts=a.id.split("-");optionId=parts[2];this.config.options[optionId].isMulti||(selectionId=this.config.selected[optionId][0],this.config.options[optionId].selections[selectionId].qty=1*a.value,this.reloadPrice())},validationCallback:function(a,c){if(void 0!=a&&void 0!=$(a)){var b=$(a).up("ul.options-list");"undefined"!=typeof b&&("failed"==c?(b.removeClassName("validation-passed"),b.addClassName("validation-failed")):(b.removeClassName("validation-failed"),
b.addClassName("validation-passed")))}}};